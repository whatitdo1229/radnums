<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleischner Criteria for Pulmonary Nodules</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="form-container">
        <h1>Fleischner Society Guidelines (2017)</h1>
        <form id="fleischner-form">
            <!-- Step 1: Eligibility -->
            <label for="age">Patient Age:</label>
            <input type="number" id="age" min="0" required>

            <label>Does the patient have known cancer, immunosuppression, or is this a screening CT?</label>
            <select id="special-case">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </select>

            <!-- Nodule Basics -->
            <label>Nodule Type:</label>
            <select id="nodule-type" onchange="toggleSections()">
                <option value="">Select</option>
                <option value="solid">Solid</option>
                <option value="subsolid">Subsolid</option>
            </select>

            <label>Is it Perifissural? (Solid only)</label>
            <select id="perifissural">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </select>

            <label>Number of Nodules:</label>
            <select id="number">
                <option value="single">Single</option>
                <option value="multiple">Multiple (manage by most suspicious)</option>
            </select>

            <label>Patient Risk Level:</label>
            <select id="risk">
                <option value="low">Low (≤5% cancer risk)</option>
                <option value="high">High (>5% cancer risk)</option>
            </select>

            <!-- Solid Section -->
            <div id="solid-section" style="display: none;">
                <label>Average Size (mm):</label>
                <input type="number" id="solid-size" min="0">
            </div>

            <!-- Subsolid Section -->
            <div id="subsolid-section" style="display: none;">
                <label>Subsolid Subtype:</label>
                <select id="subsolid-subtype">
                    <option value="pure">Pure Ground-Glass</option>
                    <option value="part">Part-Solid</option>
                </select>

                <label>Total Average Size (mm):</label>
                <input type="number" id="subsolid-size" min="0">

                <div id="part-solid-section" style="display: none;">
                    <label>Solid Component Size (mm):</label>
                    <input type="number" id="part-solid-size" min="0">
                </div>

                <label>Is it Persistent? (Confirmed on follow-up)</label>
                <select id="persistent">
                    <option value="yes">Yes</option>
                    <option value="no">No (Transient)</option>
                </select>
            </div>

            <button type="button" class="button" onclick="calculateFleischner()">Calculate Recommendation</button>
        </form>
        <div id="result" class="result"></div>
    </div>

    <script>
        function toggleSections() {
            const type = document.getElementById('nodule-type').value;
            document.getElementById('solid-section').style.display = type === 'solid' ? 'block' : 'none';
            document.getElementById('subsolid-section').style.display = type === 'subsolid' ? 'block' : 'none';

            if (type === 'subsolid') {
                const subtype = document.getElementById('subsolid-subtype');
                subtype.onchange = () => {
                    document.getElementById('part-solid-section').style.display = subtype.value === 'part' ? 'block' : 'none';
                };
            }
        }

        function calculateFleischner() {
            const age = parseFloat(document.getElementById('age').value);
            const specialCase = document.getElementById('special-case').value;
            const noduleType = document.getElementById('nodule-type').value;
            const perifissural = document.getElementById('perifissural').value;
            const number = document.getElementById('number').value; // Not heavily used, but noted
            const risk = document.getElementById('risk').value;
            const resultDiv = document.getElementById('result');
            let recommendation = '';
            let resultClass = 'success'; // Default to green

            // Initial Checks
            if (age < 35 || specialCase === 'yes') {
                recommendation = 'Guidelines do not apply. Use alternative protocol (e.g., Lung-RADS for screening).';
                resultClass = 'warning';
                updateResult(recommendation, resultClass);
                return;
            }

            if (noduleType === 'solid' && perifissural === 'yes') {
                recommendation = 'Likely benign (e.g., lymph node). No follow-up required.';
                updateResult(recommendation, resultClass);
                return;
            }

            // Solid Nodules
            if (noduleType === 'solid') {
                const size = parseFloat(document.getElementById('solid-size').value);
                if (size < 6) {
                    if (risk === 'low') {
                        recommendation = 'No routine follow-up.';
                    } else {
                        recommendation = 'Optional CT at 12 months if suspicious.';
                        resultClass = 'warning';
                    }
                } else if (size >= 6 && size <= 8) {
                    recommendation = (risk === 'low' ? 'CT at 6-12 months, then optional at 18-24 months if stable.' : 'CT at 6-12 months, then at 18-24 months if stable.');
                    resultClass = 'warning';
                } else if (size > 8) {
                    recommendation = 'Consider CT at 3 months, PET/CT, or tissue sampling.';
                    resultClass = 'warning';
                }
                if (number === 'multiple') {
                    recommendation += ' (Manage by most suspicious nodule; initial CT at 3-6 months for multiples).';
                }
            }

            // Subsolid Nodules
            if (noduleType === 'subsolid') {
                const persistent = document.getElementById('persistent').value;
                if (persistent === 'no') {
                    recommendation = 'Transient (e.g., infection). No further action if resolved.';
                    updateResult(recommendation, resultClass);
                    return;
                }

                const subsolidSubtype = document.getElementById('subsolid-subtype').value;
                const totalSize = parseFloat(document.getElementById('subsolid-size').value);

                if (subsolidSubtype === 'pure') {
                    if (totalSize < 6) {
                        recommendation = 'No routine follow-up.';
                    } else {
                        recommendation = 'CT at 6-12 months, then every 2 years up to 5 years if stable.';
                        resultClass = 'warning';
                    }
                } else if (subsolidSubtype === 'part') {
                    const solidComp = parseFloat(document.getElementById('part-solid-size').value);
                    if (solidComp < 6) {
                        recommendation = 'CT at 3-6 months, then annual CT for 5 years if stable.';
                        resultClass = 'warning';
                    } else {
                        recommendation = 'Highly suspicious: CT at 3-6 months, then at 2 and 4 years if stable; consider resection.';
                        resultClass = 'warning';
                    }
                }
            }

            if (!recommendation) {
                recommendation = 'Invalid inputs—please check all fields.';
                resultClass = 'warning';
            }
            updateResult(recommendation, resultClass);
        }

        function updateResult(text, className) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = text;
            resultDiv.className = 'result ' + className; // Apply success or warning
        }
    </script>
</body>
</html>